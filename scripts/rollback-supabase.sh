#!/bin/bash

# ================================================================
# Script de Rollback Supabase Migration
# ================================================================
# Ce script permet de revenir rapidement Ã  la configuration Supabase cloud
# en cas de problÃ¨me avec l'instance auto-hÃ©bergÃ©e

set -e  # ArrÃªt immÃ©diat en cas d'erreur

# Configuration par dÃ©faut
BACKUP_DIR="${BACKUP_DIR:-./migration-backups}"
CONFIG_BACKUP_DIR="${BACKUP_DIR}/config-backups"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
LOG_FILE="${BACKUP_DIR}/rollback_${TIMESTAMP}.log"

# URLs Supabase
CLOUD_URL="${SUPABASE_CLOUD_URL:-https://psryoyugyimibjhwhvlh.supabase.co}"
CLOUD_KEY="${SUPABASE_CLOUD_KEY}"
SELFHOSTED_URL="${SUPABASE_SELFHOSTED_URL}"

# Fonction d'affichage avec timestamp
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Fonction de vÃ©rification des prÃ©requis
check_prerequisites() {
    log "ðŸ” VÃ©rification des prÃ©requis pour rollback..."
    
    # VÃ©rification que les sauvegardes existent
    if [ ! -d "$CONFIG_BACKUP_DIR" ]; then
        log "âŒ RÃ©pertoire de sauvegarde de configuration non trouvÃ©: $CONFIG_BACKUP_DIR"
        exit 1
    fi
    
    # VÃ©rification des variables requises
    if [ -z "$CLOUD_KEY" ]; then
        log "âŒ SUPABASE_CLOUD_KEY est requis"
        exit 1
    fi
    
    # CrÃ©ation du rÃ©pertoire de logs
    mkdir -p "$BACKUP_DIR"
    
    log "âœ… PrÃ©requis validÃ©s"
}

# Fonction de sauvegarde de la configuration actuelle (avant rollback)
backup_current_config() {
    log "ðŸ’¾ Sauvegarde de la configuration actuelle..."
    
    local rollback_backup_dir="${CONFIG_BACKUP_DIR}/pre-rollback-${TIMESTAMP}"
    mkdir -p "$rollback_backup_dir"
    
    # Sauvegarde du fichier client Supabase
    if [ -f "src/integrations/supabase/client.ts" ]; then
        cp "src/integrations/supabase/client.ts" "$rollback_backup_dir/client.ts.backup"
        log "Configuration Supabase client sauvegardÃ©e"
    fi
    
    # Sauvegarde des variables d'environnement actuelles
    cat > "$rollback_backup_dir/current_env.txt" << EOF
# Configuration avant rollback - $(date)
SUPABASE_URL_BEFORE_ROLLBACK=$SELFHOSTED_URL
BACKUP_TIMESTAMP=$TIMESTAMP
EOF
    
    log "âœ… Configuration actuelle sauvegardÃ©e dans $rollback_backup_dir"
}

# Fonction de restauration de la configuration cloud
restore_cloud_config() {
    log "ðŸ”„ Restauration de la configuration Supabase cloud..."
    
    # Recherche de la sauvegarde la plus rÃ©cente
    local latest_backup=$(ls -t "$CONFIG_BACKUP_DIR"/pre-migration-* 2>/dev/null | head -n1)
    
    if [ -n "$latest_backup" ] && [ -f "$latest_backup/client.ts.backup" ]; then
        log "Restauration depuis la sauvegarde: $latest_backup"
        cp "$latest_backup/client.ts.backup" "src/integrations/supabase/client.ts"
        log "âœ… Configuration client Supabase restaurÃ©e"
    else
        log "âš ï¸ Aucune sauvegarde trouvÃ©e, restauration manuelle de la configuration cloud..."
        restore_cloud_config_manual
    fi
}

# Fonction de restauration manuelle
restore_cloud_config_manual() {
    log "ðŸ”§ Restauration manuelle de la configuration cloud..."
    
    # Mise Ã  jour du fichier client.ts avec les paramÃ¨tres cloud
    cat > "src/integrations/supabase/client.ts" << EOF

// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types.ts';

export const SUPABASE_URL = "$CLOUD_URL";
export const SUPABASE_PUBLISHABLE_KEY = "$CLOUD_KEY";

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

// Initialize Supabase client
export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
  auth: {
    storage: localStorage,
    persistSession: true,
    autoRefreshToken: true,
    debug: false, // Disable debug mode to reduce potential issues
  }
});

// Completely clear all auth data (for debugging) - not used in the app but can be used to clear the auth state if needed (e.g. if you want to test the auth flow)
export const cleanupAuthState = () => {
  try {
    // Clear all localStorage items related to Supabase auth
    Object.keys(localStorage).forEach(key => {
      if (key.includes('supabase') || key.includes('sb-')) {
        localStorage.removeItem(key);
      }
    });
    
    // Clear all sessionStorage items related to Supabase auth
    Object.keys(sessionStorage || {}).forEach(key => {
      if (key.includes('supabase') || key.includes('sb-')) {
        sessionStorage.removeItem(key);
      }
    });
    
    // Clear any cookies related to auth (optional but thorough)
    document.cookie.split(';').forEach(cookie => {
      const [name] = cookie.split('=');
      if (name.trim().includes('sb-')) {
        document.cookie = \`\${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;\`;
      }
    });
    
  } catch (error) {
    console.error('Error cleaning up auth state:', error);
  }
};
EOF
    
    log "âœ… Configuration cloud restaurÃ©e manuellement"
}

# Fonction de test de connectivitÃ© cloud
test_cloud_connectivity() {
    log "ðŸ”— Test de connectivitÃ© Supabase cloud..."
    
    # Test basique avec curl si disponible
    if command -v curl &> /dev/null; then
        local test_url="${CLOUD_URL}/rest/v1/"
        if curl -s -f -H "apikey: $CLOUD_KEY" "$test_url" &> /dev/null; then
            log "âœ… ConnectivitÃ© cloud validÃ©e"
            return 0
        else
            log "âš ï¸ Test de connectivitÃ© cloud Ã©chouÃ© (mais configuration restaurÃ©e)"
            return 1
        fi
    else
        log "âš ï¸ curl non disponible - impossible de tester la connectivitÃ©"
        return 1
    fi
}

# Fonction de reconstruction de l'application
rebuild_application() {
    log "ðŸ”¨ Reconstruction de l'application..."
    
    # VÃ©rification que npm/yarn est disponible
    if command -v npm &> /dev/null; then
        log "Reconstruction avec npm..."
        npm run build 2>> "$LOG_FILE"
        if [ $? -eq 0 ]; then
            log "âœ… Build rÃ©ussi"
        else
            log "âš ï¸ Erreur de build - voir le log pour les dÃ©tails"
        fi
    elif command -v yarn &> /dev/null; then
        log "Reconstruction avec yarn..."
        yarn build 2>> "$LOG_FILE"
        if [ $? -eq 0 ]; then
            log "âœ… Build rÃ©ussi"
        else
            log "âš ï¸ Erreur de build - voir le log pour les dÃ©tails"
        fi
    else
        log "âš ï¸ npm/yarn non disponible - build manuel requis"
    fi
}

# Fonction de validation post-rollback
validate_rollback() {
    log "âœ… Validation du rollback..."
    
    # VÃ©rification que le fichier client contient l'URL cloud
    if grep -q "$CLOUD_URL" "src/integrations/supabase/client.ts"; then
        log "âœ… Configuration cloud confirmÃ©e dans client.ts"
    else
        log "âŒ Configuration cloud non trouvÃ©e dans client.ts"
        return 1
    fi
    
    # Test optionnel avec le script de validation si disponible
    if [ -f "scripts/validate-supabase-migration.ts" ]; then
        log "Test de validation avec l'instance cloud..."
        # Note: nÃ©cessiterait l'adaptation du script pour tester seulement la cible
    fi
    
    log "âœ… Rollback validÃ©"
}

# Fonction de gÃ©nÃ©ration du rapport de rollback
generate_rollback_report() {
    local report_file="${BACKUP_DIR}/rollback_report_${TIMESTAMP}.txt"
    
    cat > "$report_file" << EOF
=== RAPPORT DE ROLLBACK SUPABASE ===
Date: $(date)
Action: Rollback vers Supabase cloud
URL cloud: $CLOUD_URL
URL auto-hÃ©bergÃ©e (prÃ©cÃ©dente): $SELFHOSTED_URL

Statut: SUCCÃˆS
DurÃ©e: $(($(date +%s) - start_time)) secondes

Fichiers modifiÃ©s:
- src/integrations/supabase/client.ts

Sauvegardes crÃ©Ã©es:
- Configuration prÃ©-rollback: ${CONFIG_BACKUP_DIR}/pre-rollback-${TIMESTAMP}/

Log complet: $LOG_FILE

=== Ã‰TAPES POST-ROLLBACK ===
1. VÃ©rifier le bon fonctionnement de l'application
2. Tester l'authentification
3. Valider les fonctionnalitÃ©s critiques
4. Surveiller les logs d'erreur

=== INFORMATIONS TECHNIQUES ===
Instance auto-hÃ©bergÃ©e peut Ãªtre conservÃ©e pour debuggage
DonnÃ©es synchronisÃ©es jusqu'au moment de la migration
Rollback rapide possible vers auto-hÃ©bergÃ© si nÃ©cessaire
EOF
    
    log "ðŸ“„ Rapport de rollback gÃ©nÃ©rÃ©: $report_file"
}

# Fonction d'affichage de l'aide
show_help() {
    cat << EOF
Rollback Migration Supabase Auto-hÃ©bergÃ© vers Cloud

Usage: $0 [OPTIONS]

Variables d'environnement requises:
  SUPABASE_CLOUD_URL          (dÃ©faut: https://psryoyugyimibjhwhvlh.supabase.co)
  SUPABASE_CLOUD_KEY          (requis - clÃ© API cloud)
  SUPABASE_SELFHOSTED_URL     (optionnel - pour logging)

Options:
  BACKUP_DIR                  (dÃ©faut: ./migration-backups)

PrÃ©requis:
- Sauvegarde de configuration existante dans BACKUP_DIR/config-backups/
- ClÃ© API Supabase cloud valide

Exemple:
  export SUPABASE_CLOUD_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  $0

EOF
}

# Fonction principale
main() {
    local start_time=$(date +%s)
    
    log "ðŸš¨ DÃ‰MARRAGE DU ROLLBACK SUPABASE"
    log "Retour vers Supabase cloud: $CLOUD_URL"
    
    check_prerequisites
    backup_current_config
    restore_cloud_config
    test_cloud_connectivity
    rebuild_application
    validate_rollback
    generate_rollback_report
    
    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    
    log "ðŸŽ‰ ROLLBACK TERMINÃ‰ AVEC SUCCÃˆS!"
    log "â±ï¸ DurÃ©e totale: ${duration} secondes"
    log "ðŸ“„ Log complet: $LOG_FILE"
    log ""
    log "âš ï¸ Ã‰TAPES RECOMMANDÃ‰ES POST-ROLLBACK:"
    log "  1. Tester l'application sur $CLOUD_URL"
    log "  2. VÃ©rifier l'authentification utilisateur"
    log "  3. Valider les fonctionnalitÃ©s critiques"
    log "  4. Surveiller les erreurs pendant 24h"
}

# Gestion des arguments
case "${1:-}" in
    -h|--help)
        show_help
        exit 0
        ;;
    *)
        if [ -z "$CLOUD_KEY" ]; then
            log "âŒ SUPABASE_CLOUD_KEY est requis"
            show_help
            exit 1
        fi
        main
        ;;
esac